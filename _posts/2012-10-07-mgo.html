---
layout: default
title: golang里使用mongodb
commentIssueId: 4
---

<h2> {{ page.title}} </h2>
这里介绍用<a href="">mgo</a>用golang来访问mongodb.
<h3>安装</h3>
安装一如既往的简单
<pre class="prettyprint linenums">
<code class="shell">
go get labix.org/v2/mgo
</code>
</pre>
首先确认你的mongdb安装了,在terminal里收入mongo。
<pre class="prettyprint linenums">
<code class="shell">
mongo
➜  tmp  mongo
MongoDB shell version: 2.0.4
connecting to: test
>
</code>
</pre>

<h3> 插入和简单查询 </h3>
在下面的程序里可以看到如何插入和查询一个struct到数据库里.
<pre class="prettyprint linenums">

<code class="lang-go">
package main

import (
        "fmt"
        "labix.org/v2/mgo"
        "labix.org/v2/mgo/bson"
)

type Person struct {
        Name string
        Phone string
}

func main() {
        session, err := mgo.Dial("localhost") // mongodb运行的server名字，可以多个server
        if err != nil {
                panic(err)
        }
        defer session.Close()

        // Optional. Switch the session to a monotonic behavior.
        session.SetMode(mgo.Monotonic, true)

        c := session.DB("test").C("people")
        // 插入记录
        err = c.Insert(&Person{"Ale", "+55 53 8116 9639"},
	               &Person{"Cla", "+55 53 8402 8510"})
        if err != nil {
                panic(err)
        }

        result := Person{}
        // 查询记录
        err = c.Find(bson.M{"name": "Ale"}).One(&result)
        if err != nil {
                panic(err)
        }

        fmt.Println("Phone:", result.Phone)
}
</code>
</pre>
<h3>插入复杂的doc</h3>
mgo会自动插入关联的数据
<pre class="prettyprint linenums">
<code class="lang-go">
package main
import (
    "fmt"
    "labix.org/v2/mgo"
)

type Person struct {
    Name string
    Phone string
}

type Order struct {
    Id int
    Customer Person
}

func main() {
    p := Person{"Ting Wang", "1360109827"}
    o := Order{1, p}
    fmt.Println(o.Customer.Name)

    saveOrder(o)
}
func saveOrder(order Order) {
    
	session, err := mgo.Dial("localhost")
	if err != nil {
		panic(err)
	}
	defer session.Close()

	con := session.DB("test").C("order")
  err = con.Insert(order)
  if err != nil {
      panic(err)
  }
}
</code>
</pre>
执行之后查看数据如下:
<pre class="prettyprint linenums">
<code class="shell">
&;gt db.order.find();
{ "_id" : ObjectId("50717dbe0cdae3d7f536abb1"), "id" : 1, "customer" : { "name" : "Ting Wang", "phone" : "1360109827" } }
</code>
</pre>
<p>{{ page.date | date_to_string }}</p>
